Repository for generating large-scale LP test instances for PDLP MPC paper.

More examples and documentation will be added in the near future.

# Background on problems

## Synthetic model of the supply chain for a large retailer

### Motivation

This problem is motivated by optimizing the supply chain of a large retailer
over relatively moderate time period (e.g., a month).
The retailer sells $K$ different products (commodities) which 
it purchases from many different factories.
The retailer has $F$ factories for each commodity $k = 1, \dots, K$
and $W$ total warehouses.
The retailer needs to meet demand at its $S$ different stores
shipping the goods from the factories to the warehouses
and then to the stores.
It is assumed each commodity has a known demand at each store.
There is a shipping cost for transporting the goods from the factories to
the warehouses, and from the warehouses to the stores which is 
proportional to the distance the goods are transported.
Each commodity is produced at $F$ different factories.
The locations of these factories are different for each
commodity. It is imagined that the retailer 
is operating during peak season where each of their warehouses
has a limited normal processing capacity of goods (the average of
which is less than total demand).
However, the number of goods processed by a warehouse can be increased
by the use overtime (but the retailer must incurs extracost by doing so).
The retailer wishes to meet demand while minimizing total costs.
We allow fractional flows of goods.
This is a (fractional) multicommodity flow problem. 

We have tried to make this as simple as possible while maintaining
some realisism. In practice, one can imagine more complicated 
and larger models incorporating, for example,
the multiperiod aspect of the problem or the issue of deciding where 
to build new warehouses.

### Decision variables:

Let $u_{k,f,w} \ge 0$ be the flow from factory $(k,f)$ to warehouse $w$ for commodity $k$.
Let $v_{k,w,s} \ge 0$ be the flow from warehouse $w$ to store $s$ for commodity $k$.
Let $x_{w} \ge 0$ be the amount of overtime at warehouse $w$.

### Parameters

Let $g_{k,f}$ be the location of factory $f$ for commodity $k$.
Let $h_{w}$ be the location of warehouse $w$.
Let $q_{s}$ be the location of store $s$.
The values are generated by sampling randomly
from a uniform distribution between zero and one.

Let $d_{k,s}$ be the demand for store $s$ for commodity $k$.
The values for $d_{k,s}$ are generated in a two step process.
If the first step we generate average demands for each 
commodity
$a_{k} = 100 \exp(Z_k)$ where $Z_1, \dots, Z_K$ are sampled indepedently from a standard normal distributation.
Then demands at each store $s$ for commodity $k$ are realized by setting
$d_{k,s} \sim \text{Possion}(a_k)$.
This two step process generates more realistic data as some products have very high demand while most products have very low demand.

Let $m_{k,f}$ be the maximum production of commodity $k$ at factory
$f$. This is generated in the code using 
the formula $m_{k,f} = \frac{1}{F} \sum_{k=1}^K \sum_{s=1}^S d_{k,s}$ such 
that the factories produce the same quantity of each
code and total demand equals total supply.

Let $\gamma$ be the normal processing capacity of a
warehouse. This is generated in the code using 
the formula $\gamma = \frac{0.95}{W} \times \sum_{k=1}^K \sum_{s=1}^S d_{k,s}$
so that without using any overtime the warehouses could meet $95\%$
of total demand.
Let $\theta$ be the cost of additional overtime.
By default this is set to be $0.3$.

### Optimization model

Minimize shipping costs plus overtime costs:
$$
\min \sum_{k=1}^K \sum_{f=1}^F \sum_{w=1}^W \| g_{k,f} - h_{w} \|_2 u_{k,f,w} + \sum_{s=1}^S \sum_{w=1}^W \| h_{w} - q_s \|_2 u_{k,f,w} + \theta \sum_{w=1}^W x_{w}
$$

Flow from each factory $(f,k)$ does not exceed supply:
$$
\sum_{w=1}^W u_{k,f,w} \le m_{k, f}
$$

For each warehouse $w$, if the normal operating capacity $\gamma$ is exceeded then we
must use overtime:
$$
\sum_{k=1}^K \sum_{f=1}^F u_{k,f,w} \le \gamma + x_{w}
$$

For each commodity $k$, flow into warehouses $w$ equals flow out of warehouse $w$:
$$
\sum_{f=1}^F u_{k,f,w} = \sum_{s=1}^S v_{k,w,s} 
$$

Demand for each commodity $k$ at store $s$ is met:
$$
\sum_{w=1}^W v_{k,w,s} \ge d_{k,s}
$$

### Usage

```shell
$ mkdir problem-instances
$ julia-1.7 generate-multicommodity-flow.jl \
    --output_file problem-instances/multicommodity-flow-small-test-instance.mps.gz \
    --num_commodities 100 \
    --num_warehouses 30 \
    --num_stores 100
```

For small instances you can also solve the problem using HiGHS and generate
plots of the optimal solution for a random selection of the commodities:

```shell
$ julia-1.7 generate-multicommodity-flow.jl \
    --output_file problem-instances/multicommodity-flow-tiny-test-instance.mps.gz \
    --optimize_model \
    --folder_for_plots plot_optimal_flows
```

This was used during the development process to verify the model was producing reasonable optimal solutions.